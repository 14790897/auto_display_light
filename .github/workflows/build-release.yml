name: Build and Release AutoDisplayLight

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build executable
      run: |
        Write-Host "Building AutoDisplayLight..." -ForegroundColor Cyan
        pyinstaller autolight_tray.spec
      shell: pwsh

    - name: Get version info
      id: version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $VERSION = "${{ github.event.inputs.tag }}"
        } else {
          $VERSION = "${{ github.event.release.tag_name }}"
        }
        $COMMIT = git rev-parse --short HEAD
        $DATE = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        
        echo "version=$VERSION" >> $env:GITHUB_OUTPUT
        echo "commit=$COMMIT" >> $env:GITHUB_OUTPUT
        echo "date=$DATE" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Package release files
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path release -Force
        Copy-Item dist\\AutoDisplayLight.exe release\\
        
        # Create VERSION.txt with multi-line content
        $versionText = "AutoDisplayLight - è‡ªåŠ¨å±å¹•äº®åº¦è°ƒèŠ‚å·¥å…·`n"
        $versionText += "=========================================`n"
        $versionText += "Version: ${{ steps.version.outputs.version }}`n"
        $versionText += "Commit: ${{ steps.version.outputs.commit }}`n"
        $versionText += "Build Date: ${{ steps.version.outputs.date }}`n"
        $versionText += "Platform: Windows 10/11`n`n"
        $versionText += "åŠŸèƒ½ç‰¹ç‚¹:`n"
        $versionText += "- åŸºäºç¯å¢ƒå…‰çº¿è‡ªåŠ¨è°ƒæ•´å±å¹•äº®åº¦`n"
        $versionText += "- ç³»ç»Ÿæ‰˜ç›˜è¿è¡Œ`n"
        $versionText += "- å›¾å½¢åŒ–é…ç½®ç•Œé¢`n"
        $versionText += "- ä¸€é”®å¼€æœºè‡ªå¯åŠ¨`n"
        $versionText += "- é…ç½®æŒä¹…åŒ–`n"
        $versionText += "- ä¼ æ„Ÿå™¨è¿æ¥æµ‹è¯•`n"
        $versionText += "- é˜²æŠ–åŠ¨æœºåˆ¶`n`n"
        $versionText += "ç³»ç»Ÿè¦æ±‚:`n"
        $versionText += "- Windows 10/11`n"
        $versionText += "- Twinkle Tray (å±å¹•äº®åº¦æ§åˆ¶å·¥å…·)`n"
        $versionText += "- ESPHome TEMT6000 å…‰ç…§ä¼ æ„Ÿå™¨`n"
        Set-Content -Path release\\VERSION.txt -Encoding UTF8 -Value $versionText
        
        # Copy README as usage guide
        Copy-Item README.md release\\README.txt
        
        # Compress to zip
        Compress-Archive -Path "release\\*" -DestinationPath "AutoDisplayLight-${{ steps.version.outputs.version }}-Windows.zip"

    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          AutoDisplayLight-${{ steps.version.outputs.version }}-Windows.zip
          release/AutoDisplayLight.exe
          release/VERSION.txt
          release/README.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release (manual trigger)
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.tag }}
        name: AutoDisplayLight ${{ github.event.inputs.tag }}
        body: |
          ## AutoDisplayLight ${{ github.event.inputs.tag }}
          
          ### ğŸ“¦ ä¸‹è½½
          - `AutoDisplayLight.exe` - Windows å¯æ‰§è¡Œæ–‡ä»¶
          - `AutoDisplayLight-${{ github.event.inputs.tag }}-Windows.zip` - å®Œæ•´åŒ… (åŒ…å«ä½¿ç”¨è¯´æ˜)
          
          ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
          - ğŸŒ åŸºäºç¯å¢ƒå…‰çº¿è‡ªåŠ¨è°ƒæ•´å±å¹•äº®åº¦
          - ğŸ¨ ç³»ç»Ÿæ‰˜ç›˜è¿è¡Œ
          - âš™ï¸ å›¾å½¢åŒ–é…ç½®ç•Œé¢
          - ğŸš€ ä¸€é”®å¼€æœºè‡ªå¯åŠ¨
          - ğŸ’¾ é…ç½®æŒä¹…åŒ–
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11
          - [Twinkle Tray](https://github.com/xanderfrangos/twinkle-tray)
          - ESPHome TEMT6000 å…‰ç…§ä¼ æ„Ÿå™¨
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½ `AutoDisplayLight.exe`
          2. åŒå‡»è¿è¡Œ
          3. å³é”®æ‰˜ç›˜å›¾æ ‡ â†’ è®¾ç½® â†’ é…ç½®ä¼ æ„Ÿå™¨å’Œ Twinkle Tray
          4. å¯åŠ¨æœåŠ¡
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹å‹ç¼©åŒ…å†…çš„ README.txt
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - ç‰ˆæœ¬: ${{ steps.version.outputs.version }}
          - æäº¤: ${{ steps.version.outputs.commit }}
          - æ—¥æœŸ: ${{ steps.version.outputs.date }}
        files: |
          AutoDisplayLight-${{ github.event.inputs.tag }}-Windows.zip
          release/AutoDisplayLight.exe
          release/VERSION.txt
          release/README.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AutoDisplayLight-${{ steps.version.outputs.version }}
        path: |
          release/
          AutoDisplayLight-${{ steps.version.outputs.version }}-Windows.zip
        retention-days: 30
