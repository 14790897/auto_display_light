name: Release Firmware

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade platformio

    - name: Build firmware (Release mode)
      run: |
        echo "Building release firmware..."
        pio run

    - name: Get version info
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION="${{ github.event.release.tag_name }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Package release files
      run: |
        mkdir -p release

        # å¤åˆ¶å›ºä»¶æ–‡ä»¶
        cp .pio/build/airm2m_core_esp32c3/firmware.bin release/
        cp .pio/build/airm2m_core_esp32c3/firmware.elf release/
        cp .pio/build/airm2m_core_esp32c3/bootloader.bin release/
        cp .pio/build/airm2m_core_esp32c3/partitions.bin release/

        # åˆ›å»ºå®Œæ•´çš„çƒ§å½•åŒ…
        cd release

        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        cat > VERSION.txt << EOF
        Beautiful Eyes Firmware
        =======================
        Version: ${{ steps.version.outputs.version }}
        Commit: ${{ steps.version.outputs.commit }}
        Build Date: ${{ steps.version.outputs.date }}
        Target: ESP32-C3 (AirM2M Core)

        Features:
        - 7ç§çœ¼ç›é£Žæ ¼: æ™®é€šã€æ¶é­”ã€ç¾Žä¸½å¥³ç”Ÿã€èµ›åšæœ‹å…‹ã€æ˜Ÿç©ºå®‡å®™ã€æ˜¾è½®çœ¼ã€æ˜Ÿçž³çœ¼
        - åŒå±åŒæ­¥æ˜¾ç¤º
        - å•å‡»BOOTæŒ‰é’®: ä¸‹ä¸€ä¸ªçœ¼ç›ç±»åž‹
        - åŒå‡»BOOTæŒ‰é’®: ä¸Šä¸€ä¸ªçœ¼ç›ç±»åž‹

        Hardware:
        - ESP32-C3 (AirM2M Core)
        - 2x gc9a01 240x240 LCD Displays
        EOF

        # åˆ›å»ºè¯¦ç»†çš„çƒ§å½•è¯´æ˜Ž
        cat > FLASH_GUIDE.md << EOF
        # Beautiful Eyes Firmware Flash Guide

        ## ç‰ˆæœ¬ä¿¡æ¯
        - ç‰ˆæœ¬: ${{ steps.version.outputs.version }}
        - æäº¤: ${{ steps.version.outputs.commit }}
        - æ—¥æœŸ: ${{ steps.version.outputs.date }}

        ## ç¡¬ä»¶è¦æ±‚
        - ESP32-C3 å¼€å‘æ¿ (æŽ¨è: AirM2M Core ESP32-C3)
        - 2å— gc9a01 240x240 LCD æ˜¾ç¤ºå±ï¼ˆåŒå±åŒæ­¥æ˜¾ç¤ºï¼‰
        - USB Type-C æ•°æ®çº¿

        ## çƒ§å½•æ–¹æ³•

        ### æ–¹æ³• 1: ä½¿ç”¨ esptool.py (æŽ¨è)

        1. å®‰è£… esptool:
        \`\`\`bash
        pip install esptool
        \`\`\`

        2. è¿žæŽ¥è®¾å¤‡å¹¶æŸ¥æ‰¾ä¸²å£:
        - Windows: é€šå¸¸æ˜¯ \`COM3\`, \`COM4\`, \`COM5\` ç­‰
        - Linux/Mac: é€šå¸¸æ˜¯ \`/dev/ttyUSB0\` æˆ– \`/dev/ttyACM0\`

        3. çƒ§å½•å›ºä»¶:
        \`\`\`bash
        esptool.py --chip esp32c3 --port COM5 --baud 460800 \\
          --before default_reset --after hard_reset write_flash \\
          0x0 bootloader.bin \\
          0x8000 partitions.bin \\
          0x10000 firmware.bin
        \`\`\`

        æ³¨æ„: å°† \`COM5\` æ›¿æ¢ä¸ºä½ çš„å®žé™…ä¸²å£

        ### æ–¹æ³• 2: ä½¿ç”¨ PlatformIO

        1. å…‹éš†ä»“åº“:
        \`\`\`bash
        git clone https://github.com/14790897/beautiful-eyes-esp32.git
        cd beautiful-eyes-esp32
        \`\`\`

        2. çƒ§å½•:
        \`\`\`bash
        pio run -t upload
        \`\`\`

        ### æ–¹æ³• 3: ä½¿ç”¨ ESP Flash Download Tool (Windows)

        1. ä¸‹è½½å·¥å…·: https://www.espressif.com/en/support/download/other-tools
        2. é…ç½®å¦‚ä¸‹:
        - bootloader.bin @ 0x0
        - partitions.bin @ 0x8000
        - firmware.bin @ 0x10000
        3. é€‰æ‹© ESP32-C3, æ³¢ç‰¹çŽ‡ 460800
        4. ç‚¹å‡» START å¼€å§‹çƒ§å½•

        ## ä½¿ç”¨è¯´æ˜Ž

        ### æŒ‰é’®æŽ§åˆ¶
        - **å•å‡»** BOOT æŒ‰é’® (GPIO9): å‘ä¸‹ç¿»é¡µï¼ˆä¸‹ä¸€ä¸ªçœ¼ç›ç±»åž‹ï¼‰
        - **åŒå‡»** BOOT æŒ‰é’® (GPIO9): å‘ä¸Šç¿»é¡µï¼ˆä¸Šä¸€ä¸ªçœ¼ç›ç±»åž‹ï¼‰
        - åˆ‡æ¢é¡ºåº: æ™®é€šçœ¼ç› â†’ æ¶é­”çœ¼ç› â†’ ç¾Žä¸½å¥³ç”Ÿçœ¼ç› â†’ èµ›åšæœ‹å…‹çœ¼ç› â†’ æ˜Ÿç©ºå®‡å®™çœ¼ç› â†’ æ˜¾è½®çœ¼ â†’ æ˜Ÿçž³çœ¼ â†’ (å¾ªçŽ¯)

        ### çœ¼ç›ç±»åž‹

        **1. æ™®é€šçœ¼ç› (Normal Eye)**
        - æ ‡å‡†çš„äººç±»çœ¼ç›
        - æ£•è‰²è™¹è†œ
        - è‡ªç„¶çš„çœ¨çœ¼åŠ¨ç”»

        **2. æ¶é­”çœ¼ç› (Demon Eye)**
        - æ·±è‰²å·©è†œ
        - çº¢è‰²è™¹è†œ
        - ç«–çž³
        - å‘å…‰æ•ˆæžœ
        - å¿ƒå½¢é«˜å…‰

        **3. ç¾Žä¸½å¥³ç”Ÿçœ¼ç› (Beautiful Eye)**
        - ç²¾è‡´çš„çœ¼å¦†æ•ˆæžœ
        - å¤šå±‚è™¹è†œæ¸å˜
        - çœ¼å½±ã€çœ¼çº¿
        - æµ“å¯†ç«æ¯›
        - ä¸‰é‡é«˜å…‰
        - é—ªäº®åŠ¨ç”»

        **4. èµ›åšæœ‹å…‹çœ¼ç› (Cyber Eye)**
        - é’è‰²è™¹è†œ
        - HUDæ˜¾ç¤ºç•Œé¢
        - æ‰«æçº¿æ•ˆæžœ
        - ç½‘æ ¼çº¹ç†
        - æ•°æ®æµåŠ¨ç”»
        - å‡†æ˜Ÿçž„å‡†

        **5. æ˜Ÿç©ºå®‡å®™çœ¼ç› (Cosmic Eye)**
        - æ·±ç´«ç°å·©è†œ
        - æ˜Ÿäº‘æ¸å˜
        - æ˜Ÿç³»æ—‹è½¬
        - é—ªçƒæ˜Ÿæ˜Ÿ
        - æµæ˜Ÿæ•ˆæžœ
        - è„‰å†²å‘å…‰

        **6. æ˜¾è½®çœ¼ (Sharingan)**
        - çº¯ç™½å·©è†œ
        - é²œçº¢è‰²è™¹è†œ
        - ä¸‰å‹¾çŽ‰è®¾è®¡
        - å‹¾çŽ‰æ—‹è½¬
        - çº¢è‰²å‘å…‰

        **7. æ˜Ÿçž³çœ¼ (Star Pupil Eye)**
        - ç²‰ç´«è‰²è™¹è†œ
        - äº”è§’æ˜Ÿçž³å­”
        - å¤šå±‚æ¸å˜
        - é—ªçƒæ˜Ÿå…‰
        - ç²‰è‰²å‘å…‰

        ## æ•…éšœæŽ’é™¤

        ### çƒ§å½•å¤±è´¥
        - ç¡®ä¿è®¾å¤‡å·²è¿žæŽ¥ä¸”é©±åŠ¨å·²å®‰è£…
        - å°è¯•é™ä½Žæ³¢ç‰¹çŽ‡ (å¦‚ 115200)
        - çƒ§å½•å‰æŒ‰ä½ BOOT æŒ‰é’®

        ### å±å¹•æ— æ˜¾ç¤º
        - æ£€æŸ¥ SPI å¼•è„šè¿žæŽ¥
        - ç¡®è®¤æ˜¾ç¤ºå±ç”µæºä¾›åº”æ­£å¸¸
        - æŸ¥çœ‹ä¸²å£è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯

        ### çœ¼ç›é—­åˆä¸åŠ¨
        - è¿™æ˜¯ä¹‹å‰ç‰ˆæœ¬çš„ bugï¼Œå½“å‰ç‰ˆæœ¬å·²ä¿®å¤
        - é‡æ–°çƒ§å½•æœ€æ–°å›ºä»¶

        ### åŒå‡»ä¸å·¥ä½œæˆ–éš¾ä»¥è§¦å‘
        - æ£€æŸ¥ä¸²å£è¾“å‡ºæ˜¯å¦æœ‰åŒå‡»æ—¥å¿—
        - å¯ä»¥åœ¨ä»£ç ä¸­è°ƒæ•´åŒå‡»å‚æ•° (setIdleMs/setClickMs)
        - ç¡®ä¿ä¸¤æ¬¡ç‚¹å‡»é—´éš”åœ¨è®¾å®šæ—¶é—´å†…

        ## å¼•è„šå®šä¹‰

        ### å…±äº«SPIå¼•è„š
        | åŠŸèƒ½ | GPIO |
        |------|------|
        | SCLK | 2 |
        | MOSI | 3 |

        ### å±å¹•ä¸€å¼•è„š
        | åŠŸèƒ½ | GPIO |
        |------|------|
        | DC   | 10 |
        | CS   | 6 |
        | RST  | 7 |

        ### å±å¹•äºŒå¼•è„š
        | åŠŸèƒ½ | GPIO |
        |------|------|
        | DC   | 1 |
        | CS   | 0 |
        | RST  | 4 |

        ### æŒ‰é’®
        | åŠŸèƒ½ | GPIO |
        |------|------|
        | BOOT | 9 |

        ## æŠ€æœ¯æ”¯æŒ

        å¦‚æœ‰é—®é¢˜è¯·æäº¤ Issue: https://github.com/14790897/beautiful-eyes-esp32/issues
        EOF

        # åˆ›å»º checksums
        sha256sum *.bin *.elf > SHA256SUMS.txt

        # æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶
        cd ..
        zip -r beautiful-eyes-${{ steps.version.outputs.version }}.zip release/

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        files: |
          release/firmware.bin
          release/firmware.elf
          release/bootloader.bin
          release/partitions.bin
          release/VERSION.txt
          release/FLASH_GUIDE.md
          release/SHA256SUMS.txt
          beautiful-eyes-${{ steps.version.outputs.version }}.zip
        body_path: release/FLASH_GUIDE.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show release info
      run: |
        echo "âœ… Release ${{ steps.version.outputs.version }} created successfully!"
        echo ""
        echo "ðŸ“¦ Files included:"
        ls -lh release/
        echo ""
        echo "ðŸ”— Download URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
